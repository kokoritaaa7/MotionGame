{% extends './base.html' %}   
{% load static %} 
{% block content %}
{% include "./motiongesture.html" %}


<style>
    .modal-body h6, 
    .modal-header h5 {
        color:black;
    }
</style>


    <!-- banner-section start -->
    <section id="banner-section" class="inner-banner features shop">
        <div class="ani-img">
            <img class="img-1" src="{% static 'MG/images/banner-circle-1.png' %}" alt="icon">
            <img class="img-2" src="{% static 'MG/images/banner-circle-2.png' %}" alt="icon">
            <img class="img-3" src="{% static 'MG/images/banner-circle-2.png' %}" alt="icon">
        </div>
        <div class="banner-content d-flex align-items-center">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="main-content">
                            <h1> 리듬 게임 </h1>
                            <div class="breadcrumb-area">
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb d-flex justify-content-center">
                                        <li class="breadcrumb-item"><a href="/MG/ranking_board/">랭킹 보러가기</a></li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>
    <!-- banner-section end -->


    <!-- unity 게임 화면 (절대좌표)-->
    <div id="unity-container" class="unity-desktop">
        <div class="overlay">

                <div class="row">
                    <div class="col-lg-8">
                        <canvas id="unity-canvas" style="margin-left: 10%; margin-top: 10%;"></canvas>
                    </div>
                    <div class="col-lg-4">
                        <button class="cmn-btn" type="submit" onclick="onDisplay()" style="margin-left: 30%; margin-top: 10%; position: relative;">Webcam</button>
                        <div id="webcam"  style="margin-left: 13%;">
                        <!-- 카메라 화면 -->
                            <div class="container1">
                                <video class="input_video" style="display:none;" ></video>
                            </div>

                            <canvas class="output_canvas"></canvas>
                            <div class = "frame"></div>
                        </div>
                    </div>
                    <div id="unity-loading-bar">
                    <div id="unity-progress-bar-empty">
                        <div id="unity-progress-bar-full"></div>
                    </div>
                    </div>
                </div>

        </div>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty"></div>
            <div id="unity-progress-bar-full"></div>
        </div>
        <div id="unity-mobile-warning">
        </div>
        <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
            <div id="unity-fullscreen-button"></div>
            <div id="unity-build-title"></div>
            <div id="unity-command" name='None' style="display: none;"></div>
        </div>
    </div>

    <!-- Button trigger modal -->
    <button type="button" id="modalBtn" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter" style='display:none'>
    </button>

    <!-- Modal -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered bd-example-modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Save your score at Ranking Board🏆</h5>
                </div>
                <div class="modal-body">
                    <h6 id="modal-score" name="modal-score"></h6>
                    <h6>Ranking Board에 저장할 이름을 입력해주세요</h6><br>
                    <input type="text" placeholder="Enter Your NickName" id="nickname">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="sendScore()">Save</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>                   
                    <!-- Save 버튼 누르면 AJAX로 가서 서버로 전달 -->
                </div>
                <div style='display:none' id="hiddenScore"></div>
            </div>
        </div>
    </div>

    <script>
    // 성준님 코드 ==> unity에서 ResultSave 함수 호출하도록 함
      function ResultSave(score){

        document.getElementById('modalBtn').click() //모달 나오게 

          let text = 'Your Score is ' + score;
          document.getElementById('modal-score').InnerHTML = text
          document.getElementById('hiddenScore').InnerHTML = score
      }

      function onDisplay(){
            if($('#webcam').css('display')== 'none'){
                $('#webcam').show();
            } else{
                $('#webcam').hide();
            }
        }
    </script>

    <script>
        function sendScore() {
            let nickname = document.getElementById('nickname')
            let score = document.getElementById('hiddenScore')

            $.ajax({
                url:'/MG/sendScore',
                type:'GET',
                data:{
                    'id': nickname,
                    'score': score
                },
                success: function(res){
                    if res.flag == 0:
                        alert(nickname + '중복')
                    location.href="/MG/ranking_board"
                    // modal 끄고 Ranking Board로 이동
                },
                error: function(err){
                    alert(nickname + "님 점수가 저장되지 않았습니다")
                }
            });
        }
    </script>

    <script src="{% static 'MG/js/jquery-3.5.1.min.js' %}"></script>
    <script src="{% static 'MG/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'MG/js/slick.js' %}"></script>
    <script src="{% static 'MG/js/jquery.nice-select.min.js' %}"></script>
    <script src="{% static 'MG/js/fontawesome.js' %}"></script>
    <script src="{% static 'MG/js/countdown.jquery.js' %}"></script>
    <script src="{% static 'MG/js/jquery.counterup.min.js' %}"></script>
    <script src="{% static 'MG/js/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'MG/js/jquery.magnific-popup.min.js' %}"></script>
    <script src="{% static 'MG/js/wow.js' %}"></script>
    <script src="{% static 'MG/js/main.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>

    <script type="module">

    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');

    var csrf_token = '{{ csrf_token }}';
    var xhr = new XMLHttpRequest();
    
    let x;
    
    function onResults(results) {
      canvasCtx.save();
      canvasCtx.translate(canvasElement.width, 0);
      canvasCtx.scale(-1,1);
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(
          results.image, 0, 0, canvasElement.width, canvasElement.height);
      if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {
        

          x = JSON.stringify({landmarks})
          

          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,
                         {color: '#00FF00', lineWidth: 5});
          drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
        }
      }
      canvasCtx.restore();
    }
    let s=0;
    let t
    setInterval(function(){
      $.ajax({
            url: '../landmark_data/',
            type: 'POST',
            data: {'landmarks' : x },
            dataType : 'json',
            beforeSend: function(xhr) {
              xhr.setRequestHeader('X-CSRFToken', csrf_token);
            },
          success:function(res){
              console.log(res)
            if (res['location']=='None'){
              console.log('there is no landmarks');
              t=document.getElementById('unity-command').className=res['locaiton']
            }
            else {
              x=NaN;
              console.log(res['location']);
              t=document.getElementById('unity-command').className=res['locaiton']

            }
          },
          error:function(){
            x=NaN
            t=document.getElementById('unity-command').className=res['None']
            console.log('error')
            //데이터를 클라이언트로 보내서 해결
          }
      })
    }, 1000) // n밀리초에 한 번씩 전송 // 해당 페이지가 아니더라도 0.1초에 한번씩 데이터 전송하는 것 같음 (Console에 자꾸 에러 찍힘)
    
    const hands = new Hands({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});
    hands.setOptions({
      maxNumHands: 2,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);
    
    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({image: videoElement});
      },
      width: 1280,
      height: 720
    });
    camera.start();

    </script> 



{% endblock  %}